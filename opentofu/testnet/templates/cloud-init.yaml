#cloud-config

# Silica Testnet Node Cloud-Init Configuration
# This runs on first boot to set up the validator node

package_update: true
package_upgrade: true

packages:
  - docker.io
  - docker-compose
  - curl
  - jq
  - htop
  - iotop
  - net-tools
  - fail2ban
  - ufw

# Create silica user
users:
  - name: silica
    groups: docker, sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys:
      - ${file("~/.ssh/id_rsa.pub")}

# Write configuration files
write_files:
  # Node configuration
  - path: /opt/silica/config/validator.toml
    content: |
      node_id = "${node_name}"
      role = "Validator"
      storage_path = "/data/storage"
      node_keypair_path = "/data/keys/node_keypair.key"
      api_listen_addr = "0.0.0.0:8545"
      
      [network]
      listen_addr = "/ip4/0.0.0.0/udp/30300/quic-v1"
      bootstrap_peers = []
      max_peers = 50
      protocol = "Quic"
      chain_id = 13371
      network_id = "silica-${environment}"
      is_validator = true
      
      [network.quic_config]
      max_concurrent_streams = 200
      keep_alive_interval_ms = 5000
      connection_idle_timeout_ms = 30000
      
      [consensus]
      shard_id = 0
      view_timeout_ms = 5000
      max_batch_size = 1000
      target_block_time_ms = 3000
      validator_keypair_path = "/data/keys/consensus_keypair.json"
      
      [execution]
      max_gas_per_block = 50000000
      gas_price_minimum = 1
      
      [staking]
      minimum_stake = 1000000000
      maximum_validators_per_shard = 100
      slash_percentage = 1000

  # Docker compose for the validator
  - path: /opt/silica/docker-compose.yml
    content: |
      version: '3.8'
      
      services:
        validator:
          image: ghcr.io/silica-protocol/silica:testnet-latest
          container_name: silica-validator
          restart: unless-stopped
          command: ["validator", "--config", "/config/validator.toml", "--data-dir", "/data"]
          ports:
            - "8545:8545"
            - "30300:30300/tcp"
            - "30300:30300/udp"
          volumes:
            - ./config:/config:ro
            - ./data:/data
            - ./keys:/keys:ro
          environment:
            - RUST_LOG=info
            - RUST_BACKTRACE=1
          healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8545/health"]
            interval: 30s
            timeout: 10s
            retries: 3
          deploy:
            resources:
              limits:
                memory: 4G
              reservations:
                memory: 2G
      
        # Lightweight monitoring
        node-exporter:
          image: prom/node-exporter:latest
          container_name: node-exporter
          restart: unless-stopped
          ports:
            - "9100:9100"
          volumes:
            - /proc:/host/proc:ro
            - /sys:/host/sys:ro
            - /:/rootfs:ro
          command:
            - '--path.procfs=/host/proc'
            - '--path.sysfs=/host/sys'
            - '--path.rootfs=/rootfs'
      
      volumes:
        silica-data:

  # Systemd service for auto-start
  - path: /etc/systemd/system/silica.service
    content: |
      [Unit]
      Description=Silica Validator Node
      After=docker.service
      Requires=docker.service
      
      [Service]
      Type=simple
      WorkingDirectory=/opt/silica
      ExecStart=/usr/bin/docker-compose up
      ExecStop=/usr/bin/docker-compose down
      Restart=always
      RestartSec=10
      
      [Install]
      WantedBy=multi-user.target

  # UFW firewall rules
  - path: /opt/silica/setup-firewall.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e
      
      # Enable UFW
      ufw default deny incoming
      ufw default allow outgoing
      
      # Allow SSH (rate limited)
      ufw limit 22/tcp
      
      # Allow Silica API
      ufw allow 8545/tcp
      
      # Allow P2P
      ufw allow 30300/tcp
      ufw allow 30300/udp
      
      # Allow node exporter (only from private IPs)
      ufw allow from 10.0.0.0/8 to any port 9100
      
      # Enable firewall
      ufw --force enable
      
      echo "Firewall configured successfully"

# Commands to run on first boot
runcmd:
  # Create directories
  - mkdir -p /opt/silica/{data,keys,config}
  - chown -R silica:silica /opt/silica
  
  # Setup firewall
  - /opt/silica/setup-firewall.sh
  
  # Enable and start fail2ban
  - systemctl enable fail2ban
  - systemctl start fail2ban
  
  # Pull docker images
  - docker pull ghcr.io/silica-protocol/silica:testnet-latest
  - docker pull prom/node-exporter:latest
  
  # Enable silica service (but don't start - need keys first)
  - systemctl enable silica
  
  # Log completion
  - echo "Silica node ${node_name} (index ${node_index}) initialized" >> /var/log/silica-init.log
  - echo "Environment: ${environment}" >> /var/log/silica-init.log
  - echo "Run 'sudo systemctl start silica' after adding keys" >> /var/log/silica-init.log

# Final message
final_message: |
  Silica validator node ${node_name} setup complete!
  
  Next steps:
  1. Copy validator keys to /opt/silica/keys/
  2. Update bootstrap peers in /opt/silica/config/validator.toml
  3. Start the node: sudo systemctl start silica
  4. Check status: sudo systemctl status silica
  5. View logs: sudo docker logs -f silica-validator
